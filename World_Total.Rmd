---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
#install.packages("RODBC")
#install.packages("odbc")
#install.packages("reshape2")
#install.packages("ggplot2")
#install.packages("plyr")
#install.packages("sqldf")
install.packages("data.table")
```

```{r}
library(RODBC) #connect mysql
#library(odbc) #connect mysql
library(lubridate) #date operation
library(magrittr) #pipe operation
library(reshape2)
library(ggplot2)
library(plyr)
library(sqldf)
library(data.table)
```

```{r}
#load data into R covid19_confirmed_global
#odbc <- dbConnect(odbc::odbc(), dsn = "coronavirus19")
data_confirmed <- odbcConnect("coronavirus19",uid = "root",pwd = "1234" )
#Data Cleaning

data_confirmed <- sqlQuery(data_confirmed, "SELECT * FROM covid19_confirmed_global ")
View(data_confirmed)
```

```{r}
#load data into R covid19_confirmed_global
#odbc <- dbConnect(odbc::odbc(), dsn = "coronavirus19")
dbcon <- odbcConnect("coronavirus19",uid = "root",pwd = "1234" )
```

```{r}
#Data Cleaning
data_confirmed <- sqlQuery(dbcon, "SELECT * FROM covid19_confirmed_global ")

#Remove some columns and rename
data_confirmed <- data_confirmed[,!(names(data_confirmed) %in% c("Province.State","Lat","Long"))]%>%rename(c("Country.Region" = "Country"))
#covert from wide to long format
data_confirmed <- melt(data_confirmed,id = c("Country")) %>% rename(c("variable" = "Date"))%>% rename(c("value"="confirmed"))

#data2 <- sqldf("SELECT * FROM data1 WHERE date = '8/31/2020' group by Country order by confirmed desc ")
data_confirmed <- sqldf("SELECT * FROM data_confirmed order by Country")
#convert from charater to date and format
data_confirmed$Date <- as.Date(data_confirmed$Date,tryFormats = c("%m/%d/%Y", "%Y-%m-%d")) 
#check str
str(data_confirmed)
View(data_confirmed)

```

```{r}
#Data Cleaning
data_deaths <- sqlQuery(dbcon, "SELECT * FROM covid19_deaths_global ")
#Remove some columns and rename
data_deaths <- data_deaths[,!(names(data_deaths) %in% c("Province.State","Lat","Long"))]%>%rename(c("Country.Region" = "Country"))
#covert from wide to long format
data_deaths <- melt(data_deaths,id = c("Country")) %>% rename(c("variable" = "Date"))%>% rename(c("value"="deaths"))

#data2 <- sqldf("SELECT * FROM data1 WHERE date = '8/31/2020' group by Country order by confirmed desc ")
data_deaths <- sqldf("SELECT * FROM data_deaths order by Country")
#convert from charater to date and format
data_deaths$Date <- as.Date(data_deaths$Date,tryFormats = c("%m/%d/%Y", "%Y-%m-%d")) 

#check str
str(data_deaths)
View(data_deaths)
```



```{r}
#Data Cleaning
data_recovered <- sqlQuery(dbcon, "SELECT * FROM covid19_recovered_global ")

#Remove some columns and rename
data_recovered <- data_recovered[,!(names(data_recovered) %in% c("Province.State","Lat","Long"))]%>%rename(c("Country.Region" = "Country")) 
#covert from wide to long format
data_recovered <- melt(data_recovered,id = c("Country")) %>% rename(c("variable" = "Date"))%>% rename(c("value"="recovered"))

#data2 <- sqldf("SELECT * FROM data1 WHERE date = '8/31/2020' group by Country order by confirmed desc ")
data_recovered <- sqldf("SELECT * FROM data_recovered order by Country")
#convert from charater to date and format
data_recovered$Date <- as.Date(data_recovered$Date,tryFormats = c("%m/%d/%Y", "%Y-%m-%d")) 

#check str

str(data_recovered)
View(data_recovered)
```

```{r}
#Merge to New Table (Summarise)
data_total <- data_confirmed %>% merge(data_deaths,all = T) %>% merge(data_recovered,all = T)

#check str
str(data_total)
View(data_total)
```

```{r}
#load data into R Function data cleaning 
#odbc <- dbConnect(odbc::odbc(), dsn = "coronavirus19")
data <- odbcConnect("coronavirus19",uid = "root",pwd = "1234" )
#Data Cleaning

raw.confirmed <- sqlQuery(data, "SELECT * FROM covid19_confirmed_global")
raw.deaths <- sqlQuery(data, "SELECT * FROM covid19_deaths_global")
raw.recovered <- sqlQuery(data, "SELECT * FROM covid19_recovered_global")

#typeof(data1)
```

```{r}
cleanData <- function(data){
  #data <-subset(data, select = -c("Province.State","Lat","Long")) %>%rename(c("Country.Region" = "Country"))
  data <- data[,!(names(data) %in% c("Province.State","Lat","Long"))] %>%rename(c("Country.Region" = "country"))
  #data <- data[,!(names(data) %in% c("Lat","Long"))] %>%rename(c("Country.Region" = "country"))
  data <- melt(data,id = c("country")) %>% rename(c("variable" = "date")) %>% rename(c("value"="count"))
  data <- sqldf("SELECT * FROM data order by country") %>% as.data.frame()
  data$date <- as.Date(data$date, tryFormats = c("%m/%d/%Y", "%Y-%m-%d")) 
  return(data)
}
```

```{r}
data.confirmed <- raw.confirmed %>% cleanData() %>% rename(c("count"="confirmed"))
data.confirmed
data.deaths <- raw.deaths %>% cleanData() %>% rename(c("count"="deaths"))
data.deaths
data.recovered <- raw.recovered %>% cleanData() %>% rename(c("count"="recovered"))
data.recovered
```

```{r}
# Merge to New Table (Summarise) -- function
merge.data <- data.confirmed %>% merge(data.deaths,all = T) %>% merge(data.recovered,all = T)
#data.total <- unique(data.total[, 0:5])
data.total <- merge.data[!duplicated(merge.data),]
#check str
#str(data.total)
View(data.total)
```



```{r}
data.total$country <- "World"
data.total
```

```{r}
for (i in 1:data.total[2])
  print
```

```{r}

```


```{r}
# Worldwide Cases
#data.World <- data.total[data.total$Date == max(data.total$Date), ]

#data.World <- aggregate(data.total, list(date = data.total$date, country = data.total$country), FUN = sum)
#data.World

#df <- subset(data.total, select = -c(country)) 
world.confirmed  <- aggregate(. ~date + country, data = data.total, sum, na.rm=TRUE)
world.confirmed 

#world.Total <- aggregate(x = data.total[c("confirmed", "deaths", "recovered")], by = list(date = data.total$date), FUN = sum)
#world.Total 
```


```{r}
# Top 20 of World
select_month <- month(as.POSIXlt(data.confirmed$Date, format="%y/%m/%d"))
confirmedTop20 <- sqldf(data.confirmed, "SELECT Country, confirmed
                                            WHERE Date = "2020-04-30"
                                            ORDER BY confirmed
                           ")
```


```{r}
#counts for the whole world
data_world <- data_total %>% 
  summarise(Country='World',
            confirmed = sum(confirmed,na.rm = T),
            deaths = sum(deaths,na.rm = T),
            recovered = sum(recovered,na.rm = T))
#data.world <- sqldf("SELECT * FROM data.world order by Country")
#data <- data_total %>% merge(data.word,all = T) 

data_total %<>% rbind(data_world)
#current confirmed case
data_world %<>% mutate(current.confirmed = confirmed - deaths - recovered)
View(data.world)
```


```{r}
#load data into R
odbc <- dbConnect(odbc::odbc(), dsn = "coronavirus")

#dbListTables(odbc) #is used for listing all existing tables in a database.
#data <- dbReadTable(odbc, "covid19_confirmed_global") #will read a full table into an R data.frame()
#rdate <- as.Date(data$date,"%Y-%m-%d")


#range(rdate)
#data.top <- rdate %>% filter(date == max(date))
#data.top
result <- dbSendQuery(odbc, "SELECT date, location, total_cases,total_deaths FROM 
covid19_confirmed_global WHERE date = '2020-08-31' group by location order by total_cases desc")
#rdate <- as.Date(full_data$date,"%Y-%m-%d")
#str(date)
#result
#top <- dbFetch(result,n=10)
#top["death_per_case"] <- 100*top$total_deaths/top$total_cases
#head(data)
#top
View(data)
#my.data

```
```{r}
ggplot(top,aes(total_cases))+geom_histogram()
```
```{r}

top$date <- as.Date(top$date,"%Y-%m-%d")
str(top$date)
top
```
```{r}
top$date <- as.Date(top$date,tryFormats = c("%Y-%m-%d","%m/%d/%Y"))
str(top$date)
top

```

